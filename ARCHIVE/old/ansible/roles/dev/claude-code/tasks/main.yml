---
- name: Check if Claude Code is already installed
  ansible.builtin.stat:
    path: "{{ lookup('env', 'HOME') }}/.local/bin/claude"
  register: claude_check

- name: Install Claude Code via official install script
  when: not claude_check.stat.exists
  block:
    - name: Download and execute Claude Code install script
      ansible.builtin.shell: |
        curl -fsSL https://claude.ai/install.sh | bash
      args:
        executable: /bin/bash
      changed_when: true

- name: Verify Claude Code installation
  ansible.builtin.command: "{{ lookup('env', 'HOME') }}/.local/bin/claude --version"
  register: claude_version
  changed_when: false
  failed_when: claude_version.rc != 0
